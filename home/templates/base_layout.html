{% load static %}

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{{ site_config.full_name }}{% endblock %}</title>
    {% if site_config.favicon %}
        <link rel="shortcut icon" type="image/png" href="{{ site_config.favicon.url }}"/>
    {% endif %}
    <link rel="stylesheet" type="text/css" href="{% static 'typeface-hind/index.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static '@fortawesome/fontawesome-free/css/all.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'bootstrap-4/dist/css/bootstrap.min.css' %}">
    <link href="{% static 'home/css/style.css' %}" rel="stylesheet">
    <link href="{% static 'blog/css/style.css' %}" rel="stylesheet">
    <link href="{% static 'projects/css/style.css' %}" rel="stylesheet">
    <!-- Highlight.js for code syntax highlighting -->
    <link id="hljs-theme" rel="stylesheet" href="{% static '@highlightjs/cdn-assets/styles/github.min.css' %}">
    {% block extra_css %}{% endblock %}
    
    <!-- Load theme before page renders to prevent flash -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // If no saved preference, don't set data-theme to use system preference
            // Otherwise use the saved theme
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else if (prefersDark) {
                // System prefers dark but no saved preference - let CSS handle it
                // Update hljs theme for system dark mode
                document.getElementById('hljs-theme').href = "{% static '@highlightjs/cdn-assets/styles/github-dark.min.css' %}";
            }
            
            // Update hljs theme if saved theme is dark
            if (savedTheme === 'dark') {
                document.getElementById('hljs-theme').href = "{% static '@highlightjs/cdn-assets/styles/github-dark.min.css' %}";
            }
        })();
    </script>
    
    <script type="text/javascript" src="{% static 'jquery-3/dist/jquery.min.js' %}"></script> 
    <script type="text/javascript" src="{% static 'bootstrap-4/dist/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'htmx.org/dist/htmx.min.js' %}"></script>
    <script src="{% static '@highlightjs/cdn-assets/highlight.min.js' %}"></script>
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="{% static 'katex/dist/katex.min.css' %}">
    <script src="{% static 'katex/dist/katex.min.js' %}"></script>
    <script src="{% static 'katex/dist/contrib/auto-render.min.js' %}"></script>
</head>

<body {% block body_attrs %}{% endblock %} class="preloader-active">

<!-- Loading Circle - only loads once on initial page load -->
<div id="preloader" style="background: var(--color-bg-white)">
    <div id="status">
        <div class="status-mes"></div>
    </div>
</div>

{% include 'home/navbar.html' with active_page=active_page %}

<div id="main-content" {% block content_attrs %}{% endblock %}>
    {% block content %}
    {% endblock %}
</div>

{% block extra_js %}{% endblock %}

<script>
    function updateActiveNavLink() {
        const path = window.location.pathname;
        const navItems = document.querySelectorAll('.navbar-nav .nav-item');
        
        navItems.forEach(function(item) {
            item.classList.remove('active');
        });
        
        navItems.forEach(function(item) {
            const link = item.querySelector('.nav-link');
            if (link) {
                const href = link.getAttribute('href');
                // Check for exact match on home, or path starts with for others
                if (path === '/' && href === '/') {
                    item.classList.add('active');
                } else if (path.startsWith('/projects') && href.includes('/projects')) {
                    item.classList.add('active');
                } else if (path.startsWith('/blog') && href.includes('/blog')) {
                    item.classList.add('active');
                }
            }
        });
    }
    
    // Run on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateActiveNavLink();
        // Initialize syntax highlighting
        document.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
        });
        
        // Initialize theme
        initializeTheme();
        
        // Wrap tables for scrollable overflow
        wrapTablesForScroll();
    });
    
    // Dark mode functionality
    function initializeTheme() {
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleDesktop = document.getElementById('theme-toggle-desktop');
        const htmlElement = document.documentElement;
        
        // Get current effective theme (considering system preference)
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const effectiveTheme = savedTheme || (prefersDark ? 'dark' : 'light');
        
        updateThemeIcon(effectiveTheme);
        
        // Toggle theme function
        function toggleTheme() {
            const currentTheme = htmlElement.getAttribute('data-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Determine current effective theme
            let effectiveCurrentTheme;
            if (currentTheme) {
                effectiveCurrentTheme = currentTheme;
            } else {
                effectiveCurrentTheme = prefersDark ? 'dark' : 'light';
            }
            
            // Toggle to opposite
            const newTheme = effectiveCurrentTheme === 'dark' ? 'light' : 'dark';
            
            htmlElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            updateSyntaxHighlighting(newTheme);
        }
        
        // Attach event listeners to both buttons
        if (themeToggle) {
            themeToggle.addEventListener('click', toggleTheme);
        }
        if (themeToggleDesktop) {
            themeToggleDesktop.addEventListener('click', toggleTheme);
        }
        
        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            // Only update if user hasn't set a preference
            if (!localStorage.getItem('theme')) {
                const newTheme = e.matches ? 'dark' : 'light';
                updateThemeIcon(newTheme);
                updateSyntaxHighlighting(newTheme);
            }
        });
    }
    
    function updateThemeIcon(theme) {
        const themeIcon = document.getElementById('theme-icon');
        const themeIconDesktop = document.getElementById('theme-icon-desktop');
        
        const iconClass = theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        
        if (themeIcon) {
            themeIcon.className = iconClass;
        }
        if (themeIconDesktop) {
            themeIconDesktop.className = iconClass;
        }
    }
    
    function updateSyntaxHighlighting(theme) {
        // Remove old highlight.js theme
        const oldThemeLink = document.getElementById('hljs-theme');
        if (oldThemeLink) {
            oldThemeLink.remove();
        }
        
        // Add new theme
        const newThemeLink = document.createElement('link');
        newThemeLink.id = 'hljs-theme';
        newThemeLink.rel = 'stylesheet';
        newThemeLink.href = theme === 'dark' 
            ? "{% static '@highlightjs/cdn-assets/styles/github-dark.min.css' %}"
            : "{% static '@highlightjs/cdn-assets/styles/github.min.css' %}";
        document.head.appendChild(newThemeLink);
    }
    
    // Run after HTMX swaps content
    document.body.addEventListener('htmx:afterSwap', function(event) {
        updateActiveNavLink();
        // Scroll to top when navigating via HTMX
        if (event.detail.target.id === 'main-content') {
            window.scrollTo(0, 0);
        }
        // Re-initialize syntax highlighting for new content
        document.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
        });
        // Re-attach modal handlers for blog images
        assignBlogImageModals();
        
        // Re-render KaTeX math if available
        if (typeof renderMathInElement === 'function') {
            const el = document.querySelector('.blog-content');
            if (el) {
                renderMathInElement(el, {
                    delimiters: [
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }
        }

        // Wrap tables in scrollable div
        wrapTablesForScroll();
        
        // Remove loading classes when navigating to home page
        if (event.detail.target.id === 'main-content') {
            $('#preloader').hide(); // Immediately hide preloader on navigation
            $('body').removeClass('preloader-active');
        }
    });
    document.body.addEventListener('htmx:pushedIntoHistory', updateActiveNavLink);
    
    // Hide preloader and loading classes on initial page load
    $(document).ready(function() {
        // Add loading classes for initial page load animation
        $('#right-container').addClass('loading');
        $('#profile-image').addClass('loading');
        $('#content-loading').addClass('loading');
        
        // Then remove them after delay for animation effect
        setTimeout(function() {
            $('#right-container').removeClass('loading');
            $('#profile-image').removeClass('loading');
            $('#content-loading').removeClass('loading');
        }, 100);
        
        // Remove overflow hidden before fadeOut starts
        setTimeout(function() {
            $('body').removeClass('preloader-active');
        }, 700);
        
        $('#preloader').delay(700).fadeOut(700);
        assignBlogImageModals();
    });
    
    // Wrap tables in scrollable divs for mobile horizontal scroll
    function wrapTablesForScroll() {
        document.querySelectorAll('.blog-content table').forEach(function(table) {
            if (table.parentElement.classList.contains('table-scroll-wrapper')) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'table-scroll-wrapper';
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
        });
    }

    // Function to make blog post images clickable for modal view
    function assignBlogImageModals() {
        const modal = document.getElementById("myModal");
        if (!modal) return;
        
        const modalImg = document.getElementById("img01");
        const modalVid = document.getElementById("vid01");
        const captionText = document.getElementById("caption");
        
        // Target images inside blog content
        document.querySelectorAll('.blog-content img').forEach(function(img) {
            img.style.cursor = 'pointer';
            img.onclick = function() {
                // Save scroll position before locking
                document.body.dataset.scrollY = window.scrollY;
                document.body.style.top = '-' + window.scrollY + 'px';
                document.body.classList.add('modal-open');
                modal.style.display = "block";
                modalVid.style.display = "none";
                modalImg.style.display = "block";
                modalImg.src = this.src;
                captionText.innerHTML = this.alt || '';
                // Detect tall/narrow images and expand them
                function checkImageAspectRatio() {
                    if (modalImg.naturalHeight > 0 && modalImg.naturalWidth > 0) {
                        if (modalImg.naturalHeight > modalImg.naturalWidth) {
                            modalImg.classList.add('tall-image');
                        } else {
                            modalImg.classList.remove('tall-image');
                        }
                    }
                }
                // Check immediately for cached images
                checkImageAspectRatio();
                // Also check on load for non-cached images
                modalImg.onload = checkImageAspectRatio;
            };

            // Add visible figcaption below images that have alt text
            if (img.alt && !img.closest('figure')) {
                const figure = document.createElement('figure');
                figure.className = 'image';
                img.parentNode.insertBefore(figure, img);
                figure.appendChild(img);

                const figcaption = document.createElement('figcaption');
                figcaption.textContent = img.alt;
                figure.appendChild(figcaption);
            }
        });
        
        // Close modal helper
        function closeBlogModal() {
            modal.style.display = "none";
            var scrollY = document.body.dataset.scrollY || '0';
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            window.scrollTo(0, parseInt(scrollY));
        }

        // Close modal handlers
        const closeBtn = modal.querySelector('.close');
        if (closeBtn) {
            closeBtn.onclick = function(e) {
                e.stopPropagation();
                closeBlogModal();
            };
        }
        
        // Only close when clicking the dark backdrop itself
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeBlogModal();
            }
        });
    }
</script>

</body>

</html>
